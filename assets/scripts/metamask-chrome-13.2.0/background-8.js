LavaPack.loadBundle([[93,{"../../../shared/constants/app":4975,"../../../shared/constants/keyring":4985,"../../../shared/constants/metametrics":4989,"@metamask/base-controller":1238,"@metamask/message-manager":1614,loglevel:4096},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var r,a=(r=e("loglevel"))&&r.__esModule?r:{default:r},s=e("@metamask/message-manager"),i=e("@metamask/base-controller"),o=e("../../../shared/constants/metametrics"),l=e("../../../shared/constants/keyring"),c=e("../../../shared/constants/app");function u(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const d="EncryptionPublicKeyManager",p={unapprovedEncryptionPublicKeyMsgs:{persist:!1,anonymous:!1},unapprovedEncryptionPublicKeyMsgCount:{persist:!1,anonymous:!1}};class m extends i.BaseController{constructor({messenger:e,managerMessenger:t,getEncryptionPublicKey:n,getAccountKeyringType:r,getState:a,metricsEvent:i}){super({name:"EncryptionPublicKeyController",metadata:p,messenger:e,state:{unapprovedEncryptionPublicKeyMsgs:{},unapprovedEncryptionPublicKeyMsgCount:0}}),u(this,"_getEncryptionPublicKey",void 0),u(this,"_getAccountKeyringType",void 0),u(this,"_getState",void 0),u(this,"_encryptionPublicKeyManager",void 0),u(this,"_metricsEvent",void 0),this._getEncryptionPublicKey=n,this._getAccountKeyringType=r,this._getState=a,this._metricsEvent=i,this._encryptionPublicKeyManager=new s.EncryptionPublicKeyManager({additionalFinishStatuses:["received"],messenger:t}),this.messagingSystem.subscribe(`${d}:unapprovedMessage`,this._requestApproval.bind(this)),this._subscribeToMessageState(e,(e,t,n)=>{e.unapprovedEncryptionPublicKeyMsgs=t,e.unapprovedEncryptionPublicKeyMsgCount=n})}get unapprovedMsgCount(){return this._encryptionPublicKeyManager.getUnapprovedMessagesCount()}resetState(){this.update(()=>({unapprovedEncryptionPublicKeyMsgs:{},unapprovedEncryptionPublicKeyMsgCount:0}))}async newRequestEncryptionPublicKey(e,t){switch(await this._getAccountKeyringType(e)){case l.KeyringType.ledger:return new Promise((e,t)=>{t(new Error("Ledger does not support eth_getEncryptionPublicKey."))});case l.KeyringType.trezor:return new Promise((e,t)=>{t(new Error("Trezor does not support eth_getEncryptionPublicKey."))});case l.KeyringType.lattice:return new Promise((e,t)=>{t(new Error("Lattice does not support eth_getEncryptionPublicKey."))});case l.KeyringType.qr:return Promise.reject(new Error("QR hardware does not support eth_getEncryptionPublicKey."));default:return this._encryptionPublicKeyManager.addUnapprovedMessageAsync({from:e},t)}}async encryptionPublicKey(e){a.default.info("MetaMaskController - encryptionPublicKey");const t=e.metamaskId;try{const n=await this._encryptionPublicKeyManager.approveMessage(e),r=await this._getEncryptionPublicKey(n.from);return this._encryptionPublicKeyManager.setMessageStatusAndResult(t,r,"received"),this._acceptApproval(t),this._getState()}catch(e){throw a.default.info("MetaMaskController - eth_getEncryptionPublicKey failed.",e),this._cancelAbstractMessage(this._encryptionPublicKeyManager,t),e}}cancelEncryptionPublicKey(e){return this._cancelAbstractMessage(this._encryptionPublicKeyManager,e)}rejectUnapproved(e){Object.keys(this._encryptionPublicKeyManager.getUnapprovedMessages()).forEach(t=>{this._cancelAbstractMessage(this._encryptionPublicKeyManager,t,e)})}clearUnapproved(){this._encryptionPublicKeyManager.clearUnapprovedMessages()}_cancelAbstractMessage(e,t,n){return n&&this._metricsEvent({event:n,category:o.MetaMetricsEventCategory.Messages,properties:{action:"Encryption public key Request"}}),e.rejectMessage(t),this._rejectApproval(t),this._getState()}_subscribeToMessageState(e,t){e.subscribe(`${d}:stateChange`,e=>{const n=this._migrateMessages(e.unapprovedMessages);this.update(r=>{t(r,n,e.unapprovedMessagesCount)})})}_migrateMessages(e){const t={};for(const n of Object.keys(e)){const r=e[n],a=this._migrateMessage(r);t[n]=a}return t}_migrateMessage(e){const{messageParams:t,...n}=e;return{...n,rawSig:e.rawSig,msgParams:t.from,origin:t.origin}}_requestApproval(e){const t=e.metamaskId,n=e.origin||c.ORIGIN_METAMASK;this.messagingSystem.call("ApprovalController:addRequest",{id:t,origin:n,type:"eth_getEncryptionPublicKey"},!0).catch(()=>{})}_acceptApproval(e){this.messagingSystem.call("ApprovalController:acceptRequest",e)}_rejectApproval(e){this.messagingSystem.call("ApprovalController:rejectRequest",e,"Cancel")}}n.default=m}}},{package:"$root$",file:"app/scripts/controllers/encryption-public-key.ts"}],[94,{"../../../../shared/lib/accounts/institutional-wallet-snap":5015,"@metamask/base-controller":1238,"@metamask/controller-utils":1315,"@metamask/snaps-utils":2245,"@metamask/transaction-controller":2316},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.InstitutionalSnapController=void 0;var r=e("@metamask/transaction-controller"),a=e("@metamask/snaps-utils"),s=e("@metamask/base-controller"),i=e("@metamask/controller-utils");function o(e,t){(function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")})(e,t),t.add(e)}function l(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}const c=e("../../../../shared/lib/accounts/institutional-wallet-snap").INSTITUTIONAL_WALLET_SNAP_ID,u="InstitutionalSnapController",d={};var p=new WeakSet;class m extends s.BaseController{constructor({messenger:e}){super({messenger:e,name:u,state:{},metadata:d}),o(this,p),l(p,this,h).call(this)}async deferPublicationHook(e){if(await l(p,this,v).call(this,e)){const t=await l(p,this,g).call(this,e);return await l(p,this,M).call(this,e.id,t),!1}return!0}async beforeCheckPendingTransactionHook(e){return!await l(p,this,v).call(this,e)}}function h(){this.messagingSystem.registerActionHandler(`${u}:publishHook`,this.deferPublicationHook.bind(this)),this.messagingSystem.registerActionHandler(`${u}:beforeCheckPendingTransactionHook`,this.beforeCheckPendingTransactionHook.bind(this))}async function f(e){return await this.messagingSystem.call("SnapController:handleRequest",e)}async function g(e){const t={from:e.txParams.from,to:e.txParams.to,value:e.txParams.value,data:e.txParams.data,chainId:e.chainId},n={snapId:c,origin:i.ORIGIN_METAMASK,handler:a.HandlerType.OnRpcRequest,request:{method:"transactions.getMutableTransactionParameters",params:t}},s=await l(p,this,f).call(this,n);return{hash:s.transaction.transactionHash,nonce:s.transaction.nonce,gasLimit:s.transaction.gasLimit,maxFeePerGas:s.transaction.maxFeePerGas,maxPriorityFeePerGas:s.transaction.maxPriorityFeePerGas,type:s.transaction.type,status:r.TransactionStatus.submitted}}async function M(e,{status:t,hash:n,nonce:r,gasLimit:a,maxFeePerGas:s,maxPriorityFeePerGas:i,type:o}){return await this.messagingSystem.call("TransactionController:updateCustodialTransaction",{transactionId:e,status:t,hash:n,nonce:r,gasLimit:a,maxFeePerGas:s,maxPriorityFeePerGas:i,type:o})}async function v(e){var t;const n=await this.messagingSystem.call("AccountsController:getAccountByAddress",e.txParams.from);return null==n||null===(t=n.options.custodian)||void 0===t?void 0:t.deferPublication}n.InstitutionalSnapController=m}}},{package:"$root$",file:"app/scripts/controllers/institutional-snap/InstitutionalSnapController.ts"}],[95,{"../../../development/build/constants":438,"../../../shared/constants/alarms":4972,"../../../shared/constants/app":4975,"../../../shared/constants/keyring":4985,"../../../shared/constants/metametrics":4989,"../../../shared/constants/time":5007,"../../../shared/constants/transaction":5009,"../../../shared/lib/trace":5071,"../../../shared/modules/mv3.utils":5092,"../lib/util":220,"@metamask/base-controller":1238,"@metamask/name-controller":1743,"@metamask/utils":2361,buffer:3318,"ethereumjs-util":3575,lodash:4088,uuid:4918},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){(function(t){(function(){Object.defineProperty(n,"__esModule",{value:!0}),n.overrideAnonymousEventNames=n.getDefaultMetaMetricsControllerState=n.default=void 0;var r=e("lodash"),a=e("ethereumjs-util"),s=e("uuid"),i=e("@metamask/name-controller"),o=e("@metamask/utils"),l=e("@metamask/base-controller"),c=e("../../../shared/constants/app"),u=e("../../../shared/constants/metametrics"),d=e("../../../shared/constants/time"),p=e("../../../shared/modules/mv3.utils"),m=e("../../../shared/constants/alarms"),h=e("../lib/util"),f=e("../../../shared/constants/transaction"),g=e("../../../shared/lib/trace"),M=e("../../../development/build/constants"),v=e("../../../shared/constants/keyring");function y(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function b(e,t,n){E(e,t),t.set(e,n)}function E(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function T(e,t){return e.get(I(e,t))}function w(e,t,n){return e.set(I(e,t),n),n}function I(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}const C=n.overrideAnonymousEventNames={[f.TransactionMetaMetricsEvent.added]:f.AnonymousTransactionMetaMetricsEvent.added,[f.TransactionMetaMetricsEvent.approved]:f.AnonymousTransactionMetaMetricsEvent.approved,[f.TransactionMetaMetricsEvent.finalized]:f.AnonymousTransactionMetaMetricsEvent.finalized,[f.TransactionMetaMetricsEvent.rejected]:f.AnonymousTransactionMetaMetricsEvent.rejected,[f.TransactionMetaMetricsEvent.submitted]:f.AnonymousTransactionMetaMetricsEvent.submitted,[u.MetaMetricsEventName.SignatureRequested]:u.MetaMetricsEventName.SignatureRequestedAnon,[u.MetaMetricsEventName.SignatureApproved]:u.MetaMetricsEventName.SignatureApprovedAnon,[u.MetaMetricsEventName.SignatureRejected]:u.MetaMetricsEventName.SignatureRejectedAnon},k=e=>{setTimeout(()=>{throw e})},S=e=>{const t=[];return e.uniqueIdentifier&&t.push(e.uniqueIdentifier),e.actionId&&t.push(e.actionId),t.length&&e.isDuplicateAnonymizedEvent&&t.push("0x000"),t.length?t.join("-"):(0,h.generateRandomId)()},_={'You must pass either an "anonymousId" or a "userId".':!0},N={metaMetricsId:{persist:!0,anonymous:!0},participateInMetaMetrics:{persist:!0,anonymous:!0},latestNonAnonymousEventTimestamp:{persist:!0,anonymous:!0},fragments:{persist:!0,anonymous:!1},eventsBeforeMetricsOptIn:{persist:!0,anonymous:!1},tracesBeforeMetricsOptIn:{persist:!0,anonymous:!1},traits:{persist:!0,anonymous:!1},dataCollectionForMarketing:{persist:!0,anonymous:!1},marketingCampaignCookieId:{persist:!0,anonymous:!0},segmentApiCalls:{persist:!0,anonymous:!1}},A=()=>({participateInMetaMetrics:null,metaMetricsId:null,dataCollectionForMarketing:null,marketingCampaignCookieId:null,latestNonAnonymousEventTimestamp:0,eventsBeforeMetricsOptIn:[],tracesBeforeMetricsOptIn:[],traits:{},fragments:{},segmentApiCalls:{}});n.getDefaultMetaMetricsControllerState=A;var O=new WeakMap,P=new WeakMap,R=new WeakMap,U=new WeakMap,D=new WeakSet,L=new WeakMap;class j extends l.BaseController{constructor({state:e={},messenger:t,segment:n,version:a,environment:s,extension:i,captureException:l=k}){var c,u;super({name:"MetaMetricsController",metadata:N,state:{participateInMetaMetrics:null,metaMetricsId:null,dataCollectionForMarketing:null,marketingCampaignCookieId:null,latestNonAnonymousEventTimestamp:0,eventsBeforeMetricsOptIn:[],tracesBeforeMetricsOptIn:[],traits:{},fragments:{},segmentApiCalls:{},...e},messenger:t}),E(c=this,u=D),u.add(c),b(this,O,void 0),y(this,"chainId",void 0),y(this,"locale",void 0),y(this,"previousUserTraits",void 0),y(this,"version",void 0),b(this,P,void 0),b(this,R,void 0),b(this,U,void 0),b(this,L,(0,r.memoize)((e={})=>Object.values(e).reduce((e,t)=>e.concat(...Object.values(t)),[]))),w(O,this,e=>{const t=(0,o.getErrorMessage)(e);_[t]||l(e)}),this.chainId=I(D,this,F).call(this);const f=this.messagingSystem.call("PreferencesController:getState");this.locale=f.currentLocale.replace("_","-"),this.version="production"===s?a:`${a}-${s}`,w(P,this,i),w(R,this,s);const g=(0,r.omitBy)(e.fragments,"persist");this.messagingSystem.subscribe("PreferencesController:stateChange",({currentLocale:e})=>{this.locale=null==e?void 0:e.replace("_","-")}),this.messagingSystem.subscribe("NetworkController:networkDidChange",({selectedNetworkClientId:e})=>{this.chainId=I(D,this,F).call(this,e)}),w(U,this,n),Object.values(g).forEach(e=>{this.processAbandonedFragment(e)}),p.isManifestV3&&Object.values(e.segmentApiCalls||{}).forEach(({eventType:e,payload:t})=>{try{I(D,this,Z).call(this,e,t)}catch(e){T(O,this).call(this,e)}}),p.isManifestV3?(T(P,this).alarms.getAll().then(e=>{(0,h.checkAlarmExists)(e,m.METAMETRICS_FINALIZE_EVENT_FRAGMENT_ALARM)||T(P,this).alarms.create(m.METAMETRICS_FINALIZE_EVENT_FRAGMENT_ALARM,{delayInMinutes:1,periodInMinutes:1})}),T(P,this).alarms.onAlarm.addListener(e=>{e.name===m.METAMETRICS_FINALIZE_EVENT_FRAGMENT_ALARM&&this.finalizeAbandonedFragments()})):setInterval(()=>{this.finalizeAbandonedFragments()},30*d.SECOND)}finalizeAbandonedFragments(){Object.values(this.state.fragments).forEach(e=>{e.timeout&&e.lastUpdated&&Date.now()-e.lastUpdated/1e3>e.timeout&&this.processAbandonedFragment(e)})}generateMetaMetricsId(){return(0,a.bufferToHex)((0,a.keccak)(t.from(String(Date.now())+String(Math.round(Math.random()*Number.MAX_SAFE_INTEGER)))))}createEventFragment(e){if(!e.successEvent)throw new Error(`Must specify success event. Success event was: ${e.event}. Payload keys were: ${Object.keys(e)}. ${"object"==typeof e.properties?`Payload property keys were: ${Object.keys(e.properties)}`:""}`);const{fragments:t}=this.state,n=e.uniqueIdentifier??(0,s.v4)(),a={id:n,...e,lastUpdated:Date.now()},i=e.initialEvent===f.TransactionMetaMetricsEvent.submitted&&t[n]?{...t[n],canDeleteIfAbandoned:!1}:{};return this.update(e=>{e.fragments[n]=(0,r.merge)({},i,a)}),a.initialEvent&&this.trackEvent({event:a.initialEvent,category:a.category,properties:a.properties,sensitiveProperties:a.sensitiveProperties,page:a.page,referrer:a.referrer,revenue:a.revenue,value:a.value,currency:a.currency,environmentType:a.environmentType,actionId:e.actionId,uniqueIdentifier:e.uniqueIdentifier}),a}getEventFragmentById(e){return this.state.fragments[e]}processAbandonedFragment(e){e.canDeleteIfAbandoned?this.deleteEventFragment(e.id):this.finalizeEventFragment(e.id,{abandoned:!0})}updateEventFragment(e,t){const{fragments:n}=this.state,a=n[e];if(!a&&e.includes("transaction-submitted-"))this.update(n=>{n.fragments[e]={canDeleteIfAbandoned:!0,category:u.MetaMetricsEventCategory.Transactions,successEvent:f.TransactionMetaMetricsEvent.finalized,id:e,...t,lastUpdated:Date.now()}});else{if(!a)throw new Error(`Event fragment with id ${e} does not exist.`);this.update(n=>{n.fragments[e]=(0,r.merge)(n.fragments[e],{...t,lastUpdated:Date.now()})})}}deleteEventFragment(e){this.state.fragments[e]&&this.update(t=>{delete t.fragments[e]})}finalizeEventFragment(e,{abandoned:t=!1,page:n,referrer:r}={}){const a=this.state.fragments[e];if(!a)throw new Error(`Funnel with id ${e} does not exist.`);const s=t?a.failureEvent:a.successEvent;this.trackEvent({event:s??"",category:a.category,properties:a.properties,sensitiveProperties:a.sensitiveProperties,page:n??a.page,referrer:a.referrer??r,revenue:a.revenue,value:a.value,currency:a.currency,environmentType:a.environmentType,actionId:a.actionId,uniqueIdentifier:a.uniqueIdentifier?`${a.uniqueIdentifier}-${t?"failure":"success"}`:undefined}),this.update(t=>{delete t.fragments[e]})}identify(e){const{metaMetricsId:t,participateInMetaMetrics:n}=this.state;if(!n||!t||!e)return;if("object"!=typeof e)return void console.warn("MetaMetricsController#identify: userTraits parameter must be an object. Received type: "+typeof e);const r=I(D,this,$).call(this,e);I(D,this,Y).call(this,r)}updateExtensionUninstallUrl(e,n){const r={av:this.version};e&&(r.mmi=t.from(n).toString("base64"),r.env=T(R,this));const a=new URLSearchParams(r);T(P,this)&&T(P,this).runtime&&T(P,this).runtime.setUninstallURL(`https://metamask.io/uninstalled?${a}`)}async setParticipateInMetaMetrics(e){const{metaMetricsId:t}=this.state,n=e&&!t?this.generateMetaMetricsId():t;return this.update(t=>{t.participateInMetaMetrics=e,t.metaMetricsId=n}),e?(this.trackEventsAfterMetricsOptIn(),this.clearEventsAfterMetricsOptIn(),this.trackTracesAfterMetricsOptIn(),this.clearTracesAfterMetricsOptIn()):this.state.marketingCampaignCookieId&&this.setMarketingCampaignCookieId(null),T(R,this)!==M.ENVIRONMENT.DEVELOPMENT&&null!==n&&this.updateExtensionUninstallUrl(e,n),n}setDataCollectionForMarketing(e){const{metaMetricsId:t}=this.state;return this.update(t=>{t.dataCollectionForMarketing=e}),!e&&this.state.marketingCampaignCookieId&&this.setMarketingCampaignCookieId(null),t}setMarketingCampaignCookieId(e){this.update(t=>{t.marketingCampaignCookieId=e})}trackPage(e,t){try{if(!1===this.state.participateInMetaMetrics)return;if(null===this.state.participateInMetaMetrics&&(null==t||!t.isOptInPath))return;const{name:n,params:r,environmentType:a,page:s,referrer:i,actionId:o}=e,{metaMetricsId:l}=this.state,c=l?"userId":"anonymousId",d=l??u.METAMETRICS_ANONYMOUS_ID;I(D,this,Z).call(this,"page",{messageId:S({actionId:o}),[c]:d,name:n,properties:{params:r,locale:this.locale,chain_id:this.chainId,environment_type:a},context:I(D,this,K).call(this,i,s)})}catch(e){T(O,this).call(this,e)}}trackEvent(e,t){I(D,this,B).call(this,e),I(D,this,x).call(this,e,t).catch(e=>{T(O,this).call(this,e)})}handleMetaMaskStateUpdate(e){const t=this._buildUserTraitsObject(e);t&&this.identify(t)}trackEventsAfterMetricsOptIn(){const{eventsBeforeMetricsOptIn:e}=this.state;e.forEach(e=>{this.trackEvent(e)})}clearEventsAfterMetricsOptIn(){this.update(e=>{e.eventsBeforeMetricsOptIn=[]})}addEventBeforeMetricsOptIn(e){this.update(t=>{t.eventsBeforeMetricsOptIn.push(e)})}trackTracesAfterMetricsOptIn(){const{tracesBeforeMetricsOptIn:e}=this.state;e.forEach(e=>{"start"===e.type?(0,g.trace)(e.request):"end"===e.type&&(0,g.endTrace)(e.request)})}clearTracesAfterMetricsOptIn(){this.update(e=>{e.tracesBeforeMetricsOptIn=[]})}addTraceBeforeMetricsOptIn(e){this.update(t=>{t.tracesBeforeMetricsOptIn.push(e)})}bufferedTrace(e,t){if(this.state.participateInMetaMetrics)return t?(0,g.trace)(e,t):(0,g.trace)(e);let n;if(e.parentContext&&"object"==typeof e.parentContext){const t=e.parentContext;n=null==t?void 0:t._name}return this.addTraceBeforeMetricsOptIn({type:"start",request:{...e,parentContext:undefined,startTime:e.startTime??Date.now()},parentTraceName:n}),undefined}bufferedEndTrace(e){this.state.participateInMetaMetrics?(0,g.endTrace)(e):this.addTraceBeforeMetricsOptIn({type:"end",request:{...e,timestamp:e.timestamp??Date.now()}})}updateTraits(e){this.update(t=>{t.traits={...t.traits,...e}})}getMetaMetricsId(){let{metaMetricsId:e}=this.state;return e||(e=this.generateMetaMetricsId(),this.update(t=>{t.metaMetricsId=e})),e}_buildUserTraitsObject(e){var t,n,a;const{traits:s}=this.state,i={[u.MetaMetricsUserTrait.AddressBookEntries]:(0,r.sum)(Object.values(e.addressBook).map(r.size)),[u.MetaMetricsUserTrait.InstallDateExt]:s[u.MetaMetricsUserTrait.InstallDateExt]||"",[u.MetaMetricsUserTrait.LedgerConnectionType]:e.ledgerTransportType,[u.MetaMetricsUserTrait.NetworksAdded]:Object.values(e.networkConfigurationsByChainId).map(e=>e.chainId),[u.MetaMetricsUserTrait.NetworksWithoutTicker]:Object.values(e.networkConfigurationsByChainId).filter(({nativeCurrency:e})=>!e).map(({chainId:e})=>e),[u.MetaMetricsUserTrait.ChainIdList]:[...Object.keys(e.networkConfigurationsByChainId).map(e=>`eip155:${parseInt(e,16)}`),...Object.keys(e.multichainNetworkConfigurationsByChainId)],[u.MetaMetricsUserTrait.NftAutodetectionEnabled]:e.useNftDetection,[u.MetaMetricsUserTrait.NumberOfAccounts]:Object.values(e.internalAccounts.accounts).length,[u.MetaMetricsUserTrait.NumberOfNftCollections]:I(D,this,G).call(this,e.allNfts),[u.MetaMetricsUserTrait.NumberOfNfts]:T(L,this).call(this,e.allNfts).length,[u.MetaMetricsUserTrait.NumberOfTokens]:I(D,this,q).call(this,e.allTokens),[u.MetaMetricsUserTrait.NumberOfHDEntropies]:I(D,this,H).call(this,e)??(null===(t=this.previousUserTraits)||void 0===t?void 0:t.number_of_hd_entropies),[u.MetaMetricsUserTrait.OpenSeaApiEnabled]:e.openSeaEnabled,[u.MetaMetricsUserTrait.ThreeBoxEnabled]:!1,[u.MetaMetricsUserTrait.Theme]:e.theme||"default",[u.MetaMetricsUserTrait.TokenDetectionEnabled]:e.useTokenDetection,[u.MetaMetricsUserTrait.ShowNativeTokenAsMainBalance]:e.ShowNativeTokenAsMainBalance,[u.MetaMetricsUserTrait.CurrentCurrency]:e.currentCurrency,[u.MetaMetricsUserTrait.SecurityProviders]:e.securityAlertsEnabled?["blockaid"]:[],[u.MetaMetricsUserTrait.PetnameAddressCount]:I(D,this,Q).call(this,e),[u.MetaMetricsUserTrait.IsMetricsOptedIn]:e.participateInMetaMetrics,[u.MetaMetricsUserTrait.HasMarketingConsent]:e.dataCollectionForMarketing,[u.MetaMetricsUserTrait.TokenSortPreference]:(null===(n=e.tokenSortConfig)||void 0===n?void 0:n.key)||"",[u.MetaMetricsUserTrait.PrivacyModeEnabled]:e.preferences.privacyMode,[u.MetaMetricsUserTrait.NetworkFilterPreference]:Object.keys(e.preferences.tokenNetworkFilter||{}),[u.MetaMetricsUserTrait.ProfileId]:null===(a=Object.entries(e.srpSessionData||{}))||void 0===a||null===(a=a[0])||void 0===a||null===(a=a[1])||void 0===a||null===(a=a.profile)||void 0===a?void 0:a.profileId};if(!this.previousUserTraits&&e.participateInMetaMetrics)return this.previousUserTraits=i,i;if(this.previousUserTraits&&!(0,r.isEqual)(this.previousUserTraits,i)){const t=(0,r.pickBy)(i,(e,t)=>{const n=this.previousUserTraits[t];return!(0,r.isEqual)(n,e)});return e.participateInMetaMetrics&&(this.previousUserTraits=i),t}return null}}function F(e){const t=e||this.messagingSystem.call("NetworkController:getState").selectedNetworkClientId,{configuration:{chainId:n}}=this.messagingSystem.call("NetworkController:getNetworkClientById",t);return n}async function x(e,t){if(!(this.state.participateInMetaMetrics||null!=t&&t.isOptIn))return;const n=[];if(e.sensitiveProperties){if(!0===(null==t?void 0:t.excludeMetaMetricsId))throw new Error("sensitiveProperties was specified in an event payload that also set the excludeMetaMetricsId flag");const a=C[`${e.event}`],s={...e,event:a??e.event},i=(0,r.merge)({...s.sensitiveProperties},{...s.properties});n.push(I(D,this,X).call(this,I(D,this,V).call(this,{...s,properties:i,isDuplicateAnonymizedEvent:!0}),{...t,excludeMetaMetricsId:!0}))}n.push(I(D,this,X).call(this,I(D,this,V).call(this,e),t)),await Promise.all(n)}function B(e){if(!e.event)throw new Error(`Must specify event. Event was: ${e.event}. Payload keys were: ${Object.keys(e)}. ${"object"==typeof e.properties?`Payload property keys were: ${Object.keys(e.properties)}`:""}`)}function K(e,t=u.METAMETRICS_BACKGROUND_PAGE_OBJECT){return{app:{name:"MetaMask Extension",version:this.version},userAgent:window.navigator.userAgent,page:t,referrer:e,marketingCampaignCookieId:this.state.marketingCampaignCookieId}}function V(e){const{event:t,properties:n,revenue:a,value:s,currency:i,category:o,page:l,referrer:u,environmentType:d=c.ENVIRONMENT_TYPE_BACKGROUND}=e;let p;return p=n&&"chain_id_caip"in n&&"string"==typeof n.chain_id_caip?null:n&&"chain_id"in n&&"string"==typeof n.chain_id?n.chain_id:this.chainId,{event:t,messageId:S(e),properties:{...(0,r.omit)(n,["revenue","locale","currency","value"]),revenue:a,value:s,currency:i,category:o,locale:this.locale,chain_id:p,environment_type:d},context:I(D,this,K).call(this,u,l)}}function $(e){return Object.entries(e).reduce((e,[t,n])=>I(D,this,J).call(this,n)?{...e,[t]:n.toISOString()}:I(D,this,z).call(this,n)?{...e,[t]:n}:(console.warn(`MetaMetricsController: "${t}" value is not a valid trait type`),e),{})}function G(e={}){const t=T(L,this).call(this,e).map(e=>e.address);return new Set(t).size}function q(e){return Object.values(e).reduce((e,t)=>e+(0,r.sum)(Object.values(t).map(r.size)),0)}function H(e){var t;return(null===(t=e.keyrings)||void 0===t?void 0:t.filter(e=>e.type===v.KeyringType.hdKeyTree).length)??0}function Y(e){const{metaMetricsId:t}=this.state;if(e&&0!==Object.keys(e).length)try{I(D,this,Z).call(this,"identify",{userId:t??undefined,traits:e})}catch(e){T(O,this).call(this,e)}else console.warn("MetaMetricsController#_identify: No userTraits found")}function z(e){const t=typeof e;return"string"===t||"boolean"===t||"number"===t||I(D,this,W).call(this,e)||I(D,this,J).call(this,e)}function W(e){return Array.isArray(e)&&(e.every(e=>"string"==typeof e)||e.every(e=>"boolean"==typeof e)||e.every(e=>"number"==typeof e))}function J(e){return"[object Date]"===Object.prototype.toString.call(e)}function X(e,t){const{isOptIn:n,metaMetricsId:r,matomoEvent:a,flushImmediately:s}=t||{};let i="userId",l=this.state.metaMetricsId,c=(null==t?void 0:t.excludeMetaMetricsId)??!1;const d=Boolean(e.event.match(/^send|^confirm/iu));return!1!==(null==t?void 0:t.excludeMetaMetricsId)&&d&&(c=!0),c||n&&!r?(i="anonymousId",l=u.METAMETRICS_ANONYMOUS_ID):n&&r&&(l=r),e[i]=l??undefined,!0===a&&(e.properties.legacy_event=!0),new Promise((t,n)=>{I(D,this,Z).call(this,"track",e,e=>{if(e){const t=(0,o.isErrorWithMessage)(e)?e.message:"",r=(0,o.isErrorWithStack)(e)?e.stack:undefined,a=new Error(t);return r&&(a.stack=r),n(a)}return t()}),s&&T(U,this).flush()})}function Z(e,t,n){const{metaMetricsId:r,participateInMetaMetrics:a,latestNonAnonymousEventTimestamp:s}=this.state;if(!a||!r)return;const i=t.messageId||(0,h.generateRandomId)();let o=new Date;if(t.timestamp){const e=new Date(t.timestamp);(0,h.isValidDate)(e)&&(o=e)}const l={...t,messageId:i,timestamp:o};this.update(t=>{t.latestNonAnonymousEventTimestamp=l.anonymousId===u.METAMETRICS_ANONYMOUS_ID?s:o.valueOf(),t.segmentApiCalls[i]={eventType:e,payload:{...l,timestamp:l.timestamp.toString()}}});T(U,this)[e](l,e=>(this.update(e=>{delete e.segmentApiCalls[i]}),null==n?void 0:n(e)))}function Q(e){var t;const n=(null===(t=e.names)||void 0===t?void 0:t[i.NameType.ETHEREUM_ADDRESS])??{};return Object.keys(n).reduce((e,t)=>{const r=n[t];return e+Object.keys(r).reduce((e,t)=>{var n;return e+(Boolean(null===(n=r[t].name)||void 0===n?void 0:n.length)?1:0)},0)},0)}n.default=j}).call(this)}).call(this,e("buffer").Buffer)}}},{package:"$root$",file:"app/scripts/controllers/metametrics-controller.ts"}],[96,{"@metamask/base-controller":1238},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.MetaMetricsDataDeletionController=void 0;var r=e("@metamask/base-controller");function a(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function s(e,t){return e.get(i(e,t))}function i(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}const o="MetaMetricsDataDeletionController",l={metaMetricsDataDeletionId:{persist:!0,anonymous:!0},metaMetricsDataDeletionTimestamp:{persist:!0,anonymous:!0},metaMetricsDataDeletionStatus:{persist:!0,anonymous:!0}};var c=new WeakMap,u=new WeakSet;class d extends r.BaseController{constructor({dataDeletionService:e,messenger:t,state:n}){var r,s;super({messenger:t,metadata:l,name:o,state:{metaMetricsDataDeletionId:null,metaMetricsDataDeletionTimestamp:0,...n}}),a(r=this,s=u),s.add(r),function(e,t,n){a(e,t),t.set(e,n)}(this,c,void 0),function(e,t,n){e.set(i(e,t),n)}(c,this,e),i(u,this,p).call(this)}async createMetaMetricsDataDeletionTask(){const{metaMetricsId:e}=this.messagingSystem.call("MetaMetricsController:getState");if(!e)throw new Error("MetaMetrics ID not found");const t=await s(c,this).createDataDeletionRegulationTask(e);this.update(e=>{e.metaMetricsDataDeletionId=t??null,e.metaMetricsDataDeletionTimestamp=Date.now()}),await this.updateDataDeletionTaskStatus()}async updateDataDeletionTaskStatus(){const e=this.state.metaMetricsDataDeletionId;if(!e)throw new Error("Delete Regulation id not found");const t=await s(c,this).fetchDeletionRegulationStatus(e);this.update(e=>{e.metaMetricsDataDeletionStatus=t??undefined})}}function p(){this.messagingSystem.registerActionHandler(`${o}:createMetaMetricsDataDeletionTask`,this.createMetaMetricsDataDeletionTask.bind(this)),this.messagingSystem.registerActionHandler(`${o}:updateDataDeletionTaskStatus`,this.updateDataDeletionTaskStatus.bind(this))}n.MetaMetricsDataDeletionController=d}}},{package:"$root$",file:"app/scripts/controllers/metametrics-data-deletion/metametrics-data-deletion.ts"}],[97,{"../../../shared/constants/network":4992,"@metamask/base-controller":1238,"@metamask/keyring-api":1559,"@metamask/multichain-network-controller":1647,"@metamask/utils":2361},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.NetworkOrderController=void 0;var r=e("@metamask/keyring-api"),a=e("@metamask/base-controller"),s=e("@metamask/utils"),i=e("@metamask/multichain-network-controller"),o=e("../../../shared/constants/network");function l(e,t){(function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")})(e,t),t.add(e)}function c(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}const u={orderedNetworkList:[],enabledNetworkMap:{[s.KnownCaipNamespace.Eip155]:{[o.CHAIN_IDS.MAINNET]:!0,[o.CHAIN_IDS.LINEA_MAINNET]:!0,[o.CHAIN_IDS.BASE]:!0},[s.KnownCaipNamespace.Solana]:{[r.SolScope.Mainnet]:!0}}},d={orderedNetworkList:{persist:!0,anonymous:!0},enabledNetworkMap:{persist:!0,anonymous:!0}};var p=new WeakSet;class m extends a.BaseController{constructor({messenger:e,state:t}){super({messenger:e,metadata:d,name:"NetworkOrderController",state:{...u,...t}}),l(this,p),this.messagingSystem.subscribe("NetworkController:stateChange",e=>{this.onNetworkControllerStateChange(e)}),this.messagingSystem.subscribe("NetworkController:networkRemoved",e=>{this.onNetworkRemoved(e.chainId)})}onNetworkControllerStateChange({networkConfigurationsByChainId:e}){this.update(t=>{const n=Object.keys(e).filter(e=>!o.TEST_CHAINS.includes(e)).map(i.toEvmCaipChainId),a=[r.BtcScope.Mainnet,r.SolScope.Mainnet],s=n.filter(e=>!t.orderedNetworkList.some(({networkId:t})=>t===e)).map(e=>({networkId:e}));t.orderedNetworkList=t.orderedNetworkList.filter(({networkId:e})=>n.includes(e)||a.includes(e)).concat(s)});const t=Object.keys(this.state.enabledNetworkMap[s.KnownCaipNamespace.Eip155]);c(p,this,h).call(this,t)}onNetworkRemoved(e){const t=(0,s.isCaipChainId)(e)?e:(0,i.toEvmCaipChainId)(e),{namespace:n}=(0,s.parseCaipChainId)(t);n===s.KnownCaipNamespace.Eip155?this.update(t=>{delete t.enabledNetworkMap[n][e],0===Object.keys(t.enabledNetworkMap[n]).length&&(t.enabledNetworkMap[n]["0x1"]=!0)}):this.update(e=>{delete e.enabledNetworkMap[n][t]})}updateNetworksList(e){this.update(t=>{t.orderedNetworkList=e.map(e=>({networkId:e}))})}setEnabledNetworks(e,t){if(!t)throw new Error("namespace is required to set enabled networks");if(!e)throw new Error("chainIds is required to set enabled networks");const n=Array.isArray(e)?e:[e];this.update(e=>{const r=Object.fromEntries(n.map(e=>[e,!0]));e.enabledNetworkMap[t]=r}),c(p,this,h).call(this,n)}}function h(e){var t,n;if(0===e.length)return;const{selectedNetworkClientId:r,networkConfigurationsByChainId:a}=this.messagingSystem.call("NetworkController:getState"),s=null===(t=Object.values(a).find(e=>{var t;return(null===(t=e.rpcEndpoints)||void 0===t||null===(t=t[e.defaultRpcEndpointIndex])||void 0===t?void 0:t.networkClientId)===r}))||void 0===t?void 0:t.chainId,i=Object.values(a).find(t=>t.chainId===e[0]),o=null==i||null===(n=i.rpcEndpoints)||void 0===n||null===(n=n[i.defaultRpcEndpointIndex])||void 0===n?void 0:n.networkClientId;s&&!e.includes(s)&&o&&setTimeout(()=>{this.messagingSystem.call("NetworkController:setActiveNetwork",o)},0)}n.NetworkOrderController=m}}},{package:"$root$",file:"app/scripts/controllers/network-order.ts"}],[98,{"../../../shared/constants/onboarding":4995,"../../../shared/modules/environment":5084,"@metamask/base-controller":1238,loglevel:4096},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.getDefaultOnboardingControllerState=n.default=void 0;var r,a=e("@metamask/base-controller"),s=(r=e("loglevel"))&&r.__esModule?r:{default:r},i=e("../../../shared/constants/onboarding"),o=e("../../../shared/modules/environment");function l(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const c=()=>({seedPhraseBackedUp:null,firstTimeFlowType:null,completedOnboarding:!1});n.getDefaultOnboardingControllerState=c;const u={onboardingTabs:{}},d={seedPhraseBackedUp:{persist:!0,anonymous:!0},firstTimeFlowType:{persist:!0,anonymous:!0},completedOnboarding:{persist:!0,anonymous:!0},onboardingTabs:{persist:!1,anonymous:!1}};class p extends a.BaseController{constructor({messenger:e,state:t}){super({messenger:e,metadata:d,name:"OnboardingController",state:{seedPhraseBackedUp:null,firstTimeFlowType:null,completedOnboarding:!1,...t,...u}}),l(this,"registerOnboarding",async(e,t)=>{if(this.state.completedOnboarding)return void s.default.debug("Ignoring registerOnboarding; user already onboarded");const{onboardingTabs:n}={...this.state??{}};n&&(n[e]&&n[e]===t||(s.default.debug(`Registering onboarding tab at location '${e}' with tabId '${t}'`),this.update(r=>{r.onboardingTabs={...n,[e]:t}})))})}setSeedPhraseBackedUp(e){this.update(t=>{t.seedPhraseBackedUp=e})}completeOnboarding(){return this.update(e=>{e.completedOnboarding=!0}),!0}setFirstTimeFlowType(e){this.update(t=>{t.firstTimeFlowType=e})}getIsSocialLoginFlow(){if(!(0,o.getIsSeedlessOnboardingFeatureEnabled)())return!1;const{firstTimeFlowType:e}=this.state;return e===i.FirstTimeFlowType.socialCreate||e===i.FirstTimeFlowType.socialImport}}n.default=p}}},{package:"$root$",file:"app/scripts/controllers/onboarding.ts"}],[4,{"../../shared/constants/app":4975,"../../shared/constants/background-liveness-check":4976,"../../shared/constants/errors":4980,"../../shared/constants/messages":4988,"../../shared/constants/metametrics":4989,"../../shared/constants/offscreen-communication":4994,"../../shared/constants/onboarding":4995,"../../shared/constants/start-up-errors":5003,"../../shared/lib/get-first-preferred-lang-code":5056,"../../shared/lib/manifestFlags":5058,"../../shared/lib/promise-with-resolvers":5064,"../../shared/modules/browser-runtime.utils":5080,"../../shared/modules/caip-stream":5081,"../../shared/modules/fetch-with-timeout":5087,"../../shared/modules/mv3.utils":5092,"../../shared/modules/object.utils":5094,"../../shared/modules/selectors/networks":5100,"./constants/marketing-site-whitelist":6,"./constants/sentry-state":7,"./constants/snaps":8,"./constants/stream":9,"./first-time-state":113,"./lib/CronjobControllerStorageManager":118,"./lib/deep-links/deep-link-router":136,"./lib/deep-links/metrics":137,"./lib/ens-ipfs/setup":142,"./lib/getObjStructure":143,"./lib/migrator":147,"./lib/notification-manager":151,"./lib/safe-reload":178,"./lib/setup-initial-state-hooks":181,"./lib/start-up-errors/start-up-errors":191,"./lib/state-corruption/state-corruption-recovery":192,"./lib/stores/extension-store":194,"./lib/stores/persistence-manager":196,"./lib/stores/read-only-network-store":197,"./lib/stream-utils":198,"./lib/util":220,"./metamask-controller":221,"./migrations":424,"./offscreen":425,"./platforms/extension":426,"@metamask/notification-services-controller":1799,"@metamask/utils":2361,"extension-port-stream":3633,loglevel:4096,"readable-stream":4454,"webextension-polyfill":4951},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.loadStateFromPersistence=Ne,n.setupController=Re,e("./lib/setup-initial-state-hooks");var r=e("readable-stream"),a=W(e("loglevel")),s=W(e("webextension-polyfill")),i=e("@metamask/utils"),o=W(e("extension-port-stream")),l=e("@metamask/notification-services-controller"),c=e("../../shared/lib/promise-with-resolvers"),u=e("../../shared/constants/onboarding"),d=e("../../shared/constants/app"),p=e("../../shared/constants/messages"),m=e("../../shared/constants/background-liveness-check"),h=e("../../shared/constants/metametrics"),f=e("../../shared/modules/browser-runtime.utils"),g=e("../../shared/modules/mv3.utils"),M=e("../../shared/modules/object.utils"),v=(e("../../shared/constants/offscreen-communication"),e("../../shared/modules/selectors/networks")),y=e("../../shared/modules/caip-stream"),b=W(e("../../shared/modules/fetch-with-timeout")),E=e("../../shared/constants/errors"),T=W(e("../../shared/lib/get-first-preferred-lang-code")),w=(e("../../shared/lib/manifestFlags"),e("../../shared/constants/start-up-errors")),I=e("./lib/state-corruption/state-corruption-recovery"),C=e("./lib/stores/persistence-manager"),k=W(e("./lib/stores/extension-store")),S=(W(e("./lib/stores/read-only-network-store")),W(e("./migrations"))),_=W(e("./lib/migrator")),N=W(e("./platforms/extension")),A=e("./constants/sentry-state"),O=z(e("./lib/notification-manager")),P=z(e("./metamask-controller")),R=W(e("./lib/getObjStructure")),U=W(e("./lib/ens-ipfs/setup")),D=e("./lib/util"),L=e("./offscreen"),j=e("./lib/stream-utils"),F=W(e("./first-time-state")),x=e("./constants/marketing-site-whitelist"),B=e("./constants/stream"),K=e("./constants/snaps"),V=e("./lib/deep-links/deep-link-router"),$=e("./lib/deep-links/metrics"),G=e("./lib/safe-reload"),q=e("./lib/start-up-errors/start-up-errors"),H=e("./lib/CronjobControllerStorageManager");function Y(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,n=new WeakMap;return(Y=function(e){return e?n:t})(e)}function z(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var n=Y(t);if(n&&n.has(e))return n.get(e);var r={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&{}.hasOwnProperty.call(e,s)){var i=a?Object.getOwnPropertyDescriptor(e,s):null;i&&(i.get||i.set)?Object.defineProperty(r,s,i):r[s]=e[s]}return r.default=e,n&&n.set(e,r),r}function W(e){return e&&e.__esModule?e:{default:e}}const J="#0376C9",X="#D73847",Z=9,Q=new k.default,ee=new C.PersistenceManager({localStore:Q});global.stateHooks.getMostRecentPersistedState=()=>ee.mostRecentRetrievedState,global.logEncryptedVault=()=>{ee.logEncryptedVault()};const{sentry:te}=global;let ne={...F.default};const re={[d.ENVIRONMENT_TYPE_POPUP]:!0,[d.ENVIRONMENT_TYPE_NOTIFICATION]:!0,[d.ENVIRONMENT_TYPE_FULLSCREEN]:!0},ae=["trezor-connect"];a.default.setLevel("info",!1);const se=new N.default,ie=new O.default,oe=(0,D.getPlatform)()===d.PLATFORM_FIREFOX;let le=0,ce=!1,ue=!1;const de={},pe={};let me;const he={};const fe=new URL("https://metamask.github.io/phishing-warning/v5.0.0/"),ge=fe.toString();let Me,ve,ye;function be(){const e=(0,c.withResolvers)();Me=e.promise,ve=e.resolve,ye=e.reject}globalThis.stateHooks.onInstalledListener?globalThis.stateHooks.onInstalledListener.then(Le):s.default.runtime.onInstalled.addListener(function e(t){s.default.runtime.onInstalled.removeListener(e),Le(t)}),be();let Ee,Te,we,Ie;const Ce=new I.CorruptionHandler;function ke(){const e=(new Date).toISOString();s.default.storage.session.set({timestamp:e})}async function Se(e){const t=g.isManifestV3?(0,L.createOffscreen)():null,n=await Ne(e),r=n.data,i=await(0,T.default)();let o;if(g.isManifestV3){var l;if(!1!==(null===(l=r.PreferencesController)||void 0===l?void 0:l.enableMV3TimestampSave)){const e=2e3;ke(),setInterval(ke,e)}const e=await s.default.storage.session.get(["isFirstMetaMaskControllerSetup"]);o=(null==e?void 0:e.isFirstMetaMaskControllerSetup)===undefined,await s.default.storage.session.set({isFirstMetaMaskControllerSetup:o})}const c={},u=await async function(){const e=(0,b.default)(),t=K.PREINSTALLED_SNAPS_URLS.map(async t=>{const n=await e(t);if(t.pathname.endsWith(".json.gz")){const e=new DecompressionStream("gzip"),t=n.body.pipeThrough(e);return await new Response(t).json()}return await n.json()});return Promise.all(t)}(),d=new H.CronjobControllerStorageManager;await d.init();const{update:m,requestSafeReload:M}=(0,G.getRequestSafeReload)(ee);Re(r,i,c,o,n.meta,t,u,M,d),me.store.on("update",m),me.store.on("error",e=>{a.default.error("MetaMask controller.store error:",e),null==te||te.captureException(e)}),function(e){async function t(e,t){try{return await s.default.tabs.update(e,{url:t})}catch(e){return null==te?void 0:te.captureException(e)}}const n=!g.isManifestV3;s.default.webRequest.onBeforeRequest.addListener(r=>{var a,i,o;if(r.tabId===s.default.tabs.TAB_ID_NONE)return{};const{completedOnboarding:l}=e.onboardingController.state;if(!l)return{};if(!e.preferencesController.state.usePhishDetect)return{};if(r.initiator&&"null"!==r.initiator&&new URL(r.initiator).host===fe.host)return{};const{hostname:c,href:u,searchParams:d}=new URL(r.url);e.phishingController.maybeUpdateState();const p=e.phishingController.isBlockedRequest(r.url);let m,f;if("main_frame"!==r.type&&"sub_frame"!==r.type||(m=e.phishingController.test(r.url)),!(null!==(a=m)&&void 0!==a&&a.result||p.result))return{};let g=c;null!==(i=m)&&void 0!==i&&i.result&&p.result?f=`${m.type} and ${p.type}`:null!==(o=m)&&void 0!==o&&o.result?f=m.type:(f=p.type,g=r.initiator),oe||e.metaMetricsController.trackEvent({event:h.MetaMetricsEventName.PhishingPageDisplayed,category:h.MetaMetricsEventCategory.Phishing,properties:{url:g,referrer:{url:g},reason:f,requestDomain:p.result?c:undefined}},{excludeMetaMetricsId:!0});const M=new URLSearchParams({hostname:c,href:u}),v=new URL(ge);v.hash=M.toString();const y=v.toString();return n?"main_frame"===r.type?{redirectUrl:y}:(t(r.tabId,y),{cancel:!0}):(t(r.tabId,y),{})},{urls:["http://*/*","https://*/*","ws://*/*","wss://*/*"]},n?["blocking"]:[])}(me),g.isManifestV3||await async function(){let e;try{const t=new URL(ge);let n,r;t.hash="#extensionStartup",e=window.document.createElement("iframe"),e.setAttribute("src",t.href),e.setAttribute("sandbox","allow-scripts allow-same-origin");const a=new Promise((e,t)=>{n=e,r=t});e.addEventListener("load",n),window.document.body.appendChild(e),setTimeout(()=>r(new _e),1e3),await a}catch(e){e instanceof _e?console.warn("Phishing warning page timeout; page not guaranteed to work offline."):console.error("Failed to initialize phishing warning page",e)}finally{e&&e.remove()}}(),await(async()=>{const e=await s.default.tabs.query({url:"<all_urls>",windowType:"normal"}).then(e=>((0,f.checkForLastErrorAndLog)(),e)).catch(()=>{(0,f.checkForLastErrorAndLog)()});for(const t of e)s.default.tabs.sendMessage(t.id,{name:p.EXTENSION_MESSAGES.READY}).then(()=>{(0,f.checkForLastErrorAndLog)()}).catch(()=>{(0,f.checkForLastErrorAndLog)()})})(),new V.DeepLinkRouter({getExtensionURL:se.getExtensionURL,getState:me.getState.bind(me)}).on("navigate",async({url:e,parsed:t})=>{"redirectTo"in t||await me.metaMetricsController.trackEvent((0,$.createEvent)({signature:t.signature,url:e}))}).on("error",e=>null==te?void 0:te.captureException(e)).install()}s.default.runtime.onConnect.addListener(async e=>{e.postMessage({data:{method:m.BACKGROUND_LIVENESS_METHOD},name:"background-liveness"});try{await Me,Ee(e)}catch(n){if(null==te||te.captureException(n),(0,E.isStateCorruptionError)(n))await Ce.handleStateCorruptionError({port:e,error:n,database:ee,repairCallback:async e=>{be(),(0,I.hasVault)(e)?(await je(e),me.onboardingController.setFirstTimeFlowType(u.FirstTimeFlowType.restore)):(await ee.reset(),await je(null))}});else{var t;const r=(0,i.isObject)(n)?{message:n.message??"Unknown error",name:n.name??"UnknownError",stack:n.stack}:{message:String(n),name:"UnknownError",stack:""};(0,q.tryPostMessage)(e,w.DISPLAY_GENERAL_STARTUP_ERROR,{error:r,currentLocale:null===(t=me)||void 0===t||null===(t=t.preferencesController)||void 0===t||null===(t=t.state)||void 0===t?void 0:t.currentLocale})}}}),s.default.runtime.onConnectExternal.addListener(async(...e)=>{await Me,Te(...e)});class _e extends Error{constructor(){super("Timeout failed")}}async function Ne(e){var t,n;let r;if(e){r={data:{},meta:{}};for(const t of C.backedUpStateKeys)(0,i.hasProperty)(e,t)&&(r.data[t]=e[t]);(0,i.hasProperty)(e,"meta")&&(0,i.isObject)(e.meta)&&(r.meta=e.meta),"number"!=typeof r.meta.version&&(a.default.error("The `backup`'s `meta.version` property was missing during backup restore."),r.meta.version=155)}else{const e=!0;r=await ee.get({validateVault:e})}const s=new _.default({migrations:S.default,defaultVersion:null});s.on("error",e=>{console.warn(e);const t=(0,R.default)(r);te.captureException(e,{extra:{vaultStructure:t}})}),null!==(t=r)&&void 0!==t&&t.data||null!==(n=r)&&void 0!==n&&n.meta||(r=s.generateInitialState(ne));const o=await s.migrateData(r);if(!o)throw new Error("MetaMask - migrator returned undefined");if(!(0,i.isObject)(o.meta))throw new Error(`MetaMask - migrator metadata has invalid type '${typeof o.meta}'`);if("number"!=typeof o.meta.version)throw new Error(`MetaMask - migrator metadata version has invalid type '${typeof o.meta.version}'`);if(!(0,i.isObject)(o.data))throw new Error(`MetaMask - migrator data has invalid type '${typeof o.data}'`);return ee.setMetadata(o.meta),await ee.set(o.data),o}function Ae(e){const{metaMetricsId:t}=me.metaMetricsController.state;if(!(0,D.shouldEmitDappViewedEvent)(t))return;const n=me.getPermittedAccounts(e).length;if(0===n)return;const r=me.controllerMessenger.call("PreferencesController:getState"),a=Object.keys(r.identities).length;me.metaMetricsController.trackEvent({event:h.MetaMetricsEventName.DappViewed,category:h.MetaMetricsEventCategory.InpageProvider,referrer:{url:e},properties:{is_first_visit:!1,number_of_accounts:a,number_of_accounts_connected:n}},{excludeMetaMetricsId:!0})}function Oe(e){if(!e.sender||!e.sender.tab||!e.sender.url)return;const t=e.sender.tab.id,n=new URL(e.sender.url),{origin:r}=n;Object.keys(he).includes(t)||(he[t]=r);const a=me.controllerMessenger.call("PermissionController:hasPermissions",r),s="New Tab"!==e.sender.tab.title;a&&s&&Ae(r)}function Pe(e){const t=[d.ENVIRONMENT_TYPE_POPUP,d.ENVIRONMENT_TYPE_NOTIFICATION,d.ENVIRONMENT_TYPE_FULLSCREEN];!(Object.values(de).some(Boolean)||ce||le>0)&&t.includes(e)&&function(){const{metaMetricsId:e,participateInMetaMetrics:t}=me.metaMetricsController.state;(null!==e||t)&&me.metaMetricsController.trackEvent({event:h.MetaMetricsEventName.AppOpened,category:h.MetaMetricsEventCategory.App})}()}function Re(e,t,n,i,c,u,p,m,f){var b;me=new P.default({infuraProjectId:"b6bf7d3508c941499b10025c0776eaf8",showUserConfirmation:Ue,initState:e,initLangCode:t,platform:se,notificationManager:ie,browser:s.default,getRequestAccountTabIds:()=>pe,getOpenMetamaskTabsIds:()=>de,overrides:n,isFirstMetaMaskControllerSetup:i,currentMigrationVersion:c.version,featureFlags:{},offscreenPromise:u,preinstalledSnaps:p,requestSafeReload:m,cronjobControllerStorageManager:f}),(0,U.default)({getCurrentChainId:()=>(0,v.getCurrentChainId)({metamask:me.networkController.state}),getIpfsGateway:me.preferencesController.getIpfsGateway.bind(me.preferencesController),getUseAddressBarEnsResolution:()=>me.preferencesController.state.useAddressBarEnsResolution,provider:me.provider}),b=me,global.stateHooks.getSentryAppState=function(){const e=b.memStore.getState();return(0,M.maskObject)(e,A.SENTRY_BACKGROUND_STATE)};const E=()=>le>0||Boolean(Object.keys(de).length)||ce,T=(e,t)=>{if(!1===e)me.onClientClosed();else{if(t===d.ENVIRONMENT_TYPE_FULLSCREEN&&Boolean(Object.keys(de).length))return;me.onEnvironmentTypeClosed(t)}};function w(e,t){return e>t?`${t}+`:String(e)}function I(){const e=C(),t=function(){try{const{isNotificationServicesEnabled:e,isFeatureAnnouncementsEnabled:t}=me.notificationServicesController.state,n=Object.values(me.notificationServicesController.state.metamaskNotificationsList).filter(e=>e.type===l.NotificationServicesController.Constants.TRIGGER_TYPES.SNAP&&null===e.readDate).length,r=t?me.notificationServicesController.state.metamaskNotificationsList.filter(e=>!e.isRead&&e.type===l.NotificationServicesController.Constants.TRIGGER_TYPES.FEATURES_ANNOUNCEMENT).length:0,a=e?me.notificationServicesController.state.metamaskNotificationsList.filter(e=>!e.isRead&&e.type!==l.NotificationServicesController.Constants.TRIGGER_TYPES.FEATURES_ANNOUNCEMENT&&e.type!==l.NotificationServicesController.Constants.TRIGGER_TYPES.SNAP).length:0;return n+r+a}catch(e){return console.error("Failed to get unread notifications count:",e),0}}();let n="",r=J;e?n=w(e,Z):t>0&&(n=w(t,Z),r=X);try{const e={text:n},t={color:r};g.isManifestV3?(s.default.action.setBadgeText(e),s.default.action.setBadgeBackgroundColor(t)):(s.default.browserAction.setBadgeText(e),s.default.browserAction.setBadgeBackgroundColor(t))}catch(e){console.error("Error updating browser badge:",e)}}function C(){try{return me.appStateController.waitingForUnlock.length+me.approvalController.getTotalApprovalCount()}catch(e){return console.error("Failed to get pending approval count:",e),0}}Ee=e=>{var t;const i=e.name;if(ae.includes(e.name))return;let l=!1;const c=null!==(t=e.sender)&&void 0!==t&&t.url?new URL(e.sender.url):null;if(l=oe?re[i]:(null==c?void 0:c.origin)===`chrome-extension://${s.default.runtime.id}`,l){var u;const t=(null==n||null===(u=n.getPortStream)||void 0===u?void 0:u.call(n,e))||new o.default(e);if(me.isClientOpen=!0,me.setupTrustedCommunication(t,e.sender),Pe(i),async function(){try{await me.remoteFeatureFlagController.updateRemoteFeatureFlags()}catch(e){a.default.error("Error initializing remote feature flags:",e)}}(),i===d.ENVIRONMENT_TYPE_POPUP&&(le+=1,(0,r.finished)(t,()=>{le-=1;const e=E();me.isClientOpen=e,T(e,d.ENVIRONMENT_TYPE_POPUP)})),i===d.ENVIRONMENT_TYPE_NOTIFICATION&&(ce=!0,(0,r.finished)(t,()=>{ce=!1;const e=E();me.isClientOpen=e,T(e,d.ENVIRONMENT_TYPE_NOTIFICATION)})),i===d.ENVIRONMENT_TYPE_FULLSCREEN){const n=e.sender.tab.id;de[n]=!0,(0,r.finished)(t,()=>{delete de[n];const e=E();me.isClientOpen=e,T(e,d.ENVIRONMENT_TYPE_FULLSCREEN)})}}else if(c&&c.origin===fe.origin&&c.pathname===fe.pathname){var p;const t=(null==n||null===(p=n.getPortStream)||void 0===p?void 0:p.call(n,e))||new o.default(e);me.setupPhishingCommunication({connectionStream:t})}else{var m;if(e.sender&&e.sender.tab&&e.sender.url){const t=e.sender.tab.id,n=new URL(e.sender.url),{origin:r}=n;Oe(e),e.onMessage.addListener(e=>{e.data&&e.data.method===d.MESSAGE_TYPE.ETH_REQUEST_ACCOUNTS&&(pe[r]=t)})}if(c&&x.COOKIE_ID_MARKETING_WHITELIST_ORIGINS.some(e=>e===c.origin)){var h;const t=(null==n||null===(h=n.getPortStream)||void 0===h?void 0:h.call(n,e))||new o.default(e);me.setUpCookieHandlerCommunication({connectionStream:t})}const t=(null==n||null===(m=n.getPortStream)||void 0===m?void 0:m.call(n,e))||new o.default(e);if(we(t,e.sender),oe||!g.isManifestV3){const n=(0,j.setupMultiplex)(t);n.ignoreStream(B.METAMASK_EIP_1193_PROVIDER),Ie(n.createStream(B.METAMASK_CAIP_MULTICHAIN_PROVIDER),e.sender)}}},Te=e=>{var t;const r=(null==n||null===(t=n.getPortStream)||void 0===t?void 0:t.call(n,e))||new o.default(e);if(!e.sender.id){if(ae.includes(e.name))return;Oe(e),Ie((0,y.createCaipStream)(r),e.sender)}else we(r,e.sender)},we=(e,t)=>{me.setupUntrustedCommunicationEip1193({connectionStream:e,sender:t})},Ie=(e,t)=>{me.setupUntrustedCommunicationCaip({connectionStream:e,sender:t})},null!=n&&n.registerConnectListeners&&n.registerConnectListeners(Ee,we),I(),me.controllerMessenger.subscribe(P.METAMASK_CONTROLLER_EVENTS.DECRYPT_MESSAGE_MANAGER_UPDATE_BADGE,I),me.controllerMessenger.subscribe(P.METAMASK_CONTROLLER_EVENTS.ENCRYPTION_PUBLIC_KEY_MANAGER_UPDATE_BADGE,I),me.signatureController.hub.on(P.METAMASK_CONTROLLER_EVENTS.UPDATE_BADGE,I),me.controllerMessenger.subscribe(P.METAMASK_CONTROLLER_EVENTS.APP_STATE_UNLOCK_CHANGE,I),me.controllerMessenger.subscribe(P.METAMASK_CONTROLLER_EVENTS.APPROVAL_STATE_CHANGE,I),me.controllerMessenger.subscribe(P.METAMASK_CONTROLLER_EVENTS.METAMASK_NOTIFICATIONS_LIST_UPDATED,I),me.controllerMessenger.subscribe(P.METAMASK_CONTROLLER_EVENTS.METAMASK_NOTIFICATIONS_MARK_AS_READ,I),ie.on(O.NOTIFICATION_MANAGER_EVENTS.POPUP_CLOSED,({automaticallyClosed:e})=>{e?C()>0&&Ue():(me.signatureController.rejectUnapproved(h.REJECT_NOTIFICATION_CLOSE_SIG),me.decryptMessageController.rejectUnapproved(h.REJECT_NOTIFICATION_CLOSE),me.encryptionPublicKeyController.rejectUnapproved(h.REJECT_NOTIFICATION_CLOSE),me.rejectAllPendingApprovals()),I()}),Object.values(me.snapController.state.snaps).some(e=>!e.preinstalled)&&me.snapController.updateBlockedSnaps()}async function Ue(){const e=await se.getActiveTabs(),t=Boolean(e.find(e=>de[e.id])),n=e.length>0&&e[0].extData&&e[0].extData.indexOf("vivaldi_tab")>-1;if(!ue&&(n||0===le)&&!t){ue=!0;try{const e=me.appStateController.getCurrentPopupId();await ie.showPopup(e=>me.appStateController.setCurrentPopupId(e),e)}finally{ue=!1}}}const De=()=>{if(me)return me.metaMetricsController.updateTraits({[h.MetaMetricsUserTrait.InstallDateExt]:(new Date).toISOString().split("T")[0]}),void me.metaMetricsController.addEventBeforeMetricsOptIn({category:h.MetaMetricsEventCategory.App,event:h.MetaMetricsEventName.AppInstalled,properties:{}});setTimeout(()=>{De()},500)};function Le(e){"install"===e.reason?(a.default.debug("First install detected"),De(),se.openExtensionInBrowser()):"update"===e.reason&&e.previousVersion&&e.previousVersion!==se.getVersion()&&async function(){await Me,a.default.debug("Update installation detected"),me.appStateController.setLastUpdatedAt(Date.now())}()}async function je(e){s.default.tabs.onActivated.addListener(e=>{if(me){const{tabId:t}=e,n=he[t];n&&me.permissionController.state.subjects[n]!==undefined&&Ae(n)}});try{await Se(e),ee.cleanUpMostRecentRetrievedState(),a.default.info("MetaMask initialization complete."),ve()}catch(e){a.default.error(e),ye(e)}}s.default.runtime.onUpdateAvailable.addListener(async function(){await Me,a.default.debug("An update is available"),me.appStateController.setIsUpdateAvailable(!0)}),je(null)}}},{package:"$root$",file:"app/scripts/background.js"}]],[4],{});